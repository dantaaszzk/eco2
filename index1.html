<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EcoEscola - Gamifica√ß√£o Escolar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#4F46E5',
                        secondary: '#10B981',
                        accent: '#F59E0B',
                        danger: '#EF4444'
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .card-hover {
            transition: all 0.3s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }
        
        .mission-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .completed-mission {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        
        .streak-animation {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .ranking-gold { background: linear-gradient(135deg, #FFD700, #FFA500); }
        .ranking-silver { background: linear-gradient(135deg, #C0C0C0, #A8A8A8); }
        .ranking-bronze { background: linear-gradient(135deg, #CD7F32, #B8860B); }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1001;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }
        
        .notification.show {
            transform: translateX(0);
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Notifica√ß√£o -->
    <div id="notification" class="notification bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg">
        <div class="flex items-center">
            <span id="notificationText">Miss√£o conclu√≠da! +50 pontos</span>
            <button onclick="hideNotification()" class="ml-4 text-white hover:text-gray-200">‚úï</button>
        </div>
    </div>

    <!-- Tela de Login -->
    <div id="loginScreen" class="min-h-screen gradient-bg flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <div class="w-20 h-20 bg-primary rounded-full flex items-center justify-center mx-auto mb-4">
                    <span class="text-3xl">üè´</span>
                </div>
                <h1 class="text-3xl font-bold text-gray-800 mb-2">EcoEscola</h1>
                <p class="text-gray-600">Gamifica√ß√£o para Preserva√ß√£o Escolar</p>
            </div>
            
            <form onsubmit="login(event)" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nome do Aluno</label>
                    <input type="text" id="studentName" required 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                           placeholder="Digite seu nome completo">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Turma</label>
                    <select id="studentClass" required 
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                        <option value="">Selecione sua turma</option>
                        <option value="6A">6¬∫ Ano A</option>
                        <option value="6B">6¬∫ Ano B</option>
                        <option value="6C">6¬∫ Ano C</option>
                        <option value="6D">6¬∫ Ano D</option>
                        <option value="6E">6¬∫ Ano E</option>
                        <option value="7A">7¬∫ Ano A</option>
                        <option value="7B">7¬∫ Ano B</option>
                        <option value="7C">7¬∫ Ano C</option>
                        <option value="7D">7¬∫ Ano D</option>
                        <option value="7E">7¬∫ Ano E</option>
                        <option value="8A">8¬∫ Ano A</option>
                        <option value="8B">8¬∫ Ano B</option>
                        <option value="8C">8¬∫ Ano C</option>
                        <option value="8D">8¬∫ Ano D</option>
                        <option value="8E">8¬∫ Ano E</option>
                        <option value="9A">9¬∫ Ano A</option>
                        <option value="9B">9¬∫ Ano B</option>
                        <option value="9C">9¬∫ Ano C</option>
                        <option value="9D">9¬∫ Ano D</option>
                        <option value="9E">9¬∫ Ano E</option>
                    </select>
                </div>
                
                <button type="submit" 
                        class="w-full bg-primary text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition duration-200">
                    Entrar no EcoEscola
                </button>
            </form>
            
            <div class="mt-6 text-center">
                <button onclick="showAdminLogin()" class="text-primary hover:text-indigo-700 text-sm">
                    Acesso Professor/Admin
                </button>
            </div>
        </div>
    </div>

    <!-- Tela Principal do Aluno -->
    <div id="studentApp" class="hidden min-h-screen bg-gray-50">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center">
                        <span class="text-2xl">üè´</span>
                        <h1 class="ml-2 text-xl font-bold text-gray-900">EcoEscola</h1>
                    </div>
                    
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center bg-accent text-white px-3 py-1 rounded-full">
                            <span class="text-sm font-medium">‚≠ê <span id="userPoints">0</span> pontos</span>
                        </div>
                        
                        <div class="flex items-center bg-secondary text-white px-3 py-1 rounded-full">
                            <span class="text-sm font-medium">üî• <span id="userStreak">0</span> dias</span>
                        </div>
                        
                        <button onclick="logout()" class="text-gray-500 hover:text-gray-700">
                            <span class="text-xl">üö™</span>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Navega√ß√£o -->
        <nav class="bg-white border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex space-x-8">
                    <button onclick="showTab('missions')" id="missionsTab" 
                            class="tab-button py-4 px-1 border-b-2 border-primary text-primary font-medium">
                        Miss√µes
                    </button>
                    <button onclick="showTab('ranking')" id="rankingTab" 
                            class="tab-button py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                        Ranking
                    </button>
                    <button onclick="showTab('profile')" id="profileTab" 
                            class="tab-button py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                        Perfil
                    </button>
                    <button onclick="showTab('rewards')" id="rewardsTab" 
                            class="tab-button py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                        Recompensas
                    </button>
                </div>
            </div>
        </nav>

        <!-- Conte√∫do Principal -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Aba Miss√µes -->
            <div id="missionsContent" class="tab-content">
                <div class="mb-8">
                    <h2 class="text-2xl font-bold text-gray-900 mb-2">Suas Miss√µes</h2>
                    <p class="text-gray-600">Complete miss√µes para ganhar pontos e medalhas!</p>
                </div>

                <!-- Miss√µes Di√°rias -->
                <div class="mb-8">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                        ‚òÄÔ∏è Miss√µes Di√°rias
                        <span class="ml-2 bg-accent text-white text-xs px-2 py-1 rounded-full">Renovam todo dia</span>
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="dailyMissions">
                        <!-- Miss√µes ser√£o carregadas aqui -->
                    </div>
                </div>

                <!-- Miss√µes Semanais -->
                <div class="mb-8">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                        üìÖ Miss√µes Semanais
                        <span class="ml-2 bg-primary text-white text-xs px-2 py-1 rounded-full">Mais pontos</span>
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="weeklyMissions">
                        <!-- Miss√µes ser√£o carregadas aqui -->
                    </div>
                </div>

                <!-- Miss√µes Especiais -->
                <div>
                    <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                        ‚≠ê Miss√µes Especiais
                        <span class="ml-2 bg-purple-500 text-white text-xs px-2 py-1 rounded-full">Eventos</span>
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="specialMissions">
                        <!-- Miss√µes ser√£o carregadas aqui -->
                    </div>
                </div>
            </div>

            <!-- Aba Ranking -->
            <div id="rankingContent" class="tab-content hidden">
                <div class="mb-8">
                    <h2 class="text-2xl font-bold text-gray-900 mb-2">Ranking</h2>
                    <p class="text-gray-600">Veja quem s√£o os guardi√µes da escola!</p>
                </div>

                <!-- Filtros -->
                <div class="mb-6 flex space-x-4">
                    <button onclick="showRanking('individual')" id="individualRankingBtn" 
                            class="ranking-filter-btn bg-primary text-white px-4 py-2 rounded-lg">
                        Individual
                    </button>
                    <button onclick="showRanking('class')" id="classRankingBtn" 
                            class="ranking-filter-btn bg-gray-200 text-gray-700 px-4 py-2 rounded-lg">
                        Por Turma
                    </button>
                </div>

                <!-- P√≥dio -->
                <div class="mb-8">
                    <div class="flex justify-center items-end space-x-4" id="podium">
                        <!-- P√≥dio ser√° carregado aqui -->
                    </div>
                </div>

                <!-- Lista de Ranking -->
                <div class="bg-white rounded-lg shadow" id="rankingList">
                    <!-- Lista ser√° carregada aqui -->
                </div>
            </div>

            <!-- Aba Perfil -->
            <div id="profileContent" class="tab-content hidden">
                <div class="mb-8">
                    <h2 class="text-2xl font-bold text-gray-900 mb-2">Meu Perfil</h2>
                    <p class="text-gray-600">Acompanhe seu progresso e conquistas!</p>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- Estat√≠sticas -->
                    <div class="lg:col-span-2">
                        <div class="bg-white rounded-lg shadow p-6 mb-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Estat√≠sticas</h3>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-primary" id="profilePoints">0</div>
                                    <div class="text-sm text-gray-600">Pontos Totais</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-secondary" id="profileMissions">0</div>
                                    <div class="text-sm text-gray-600">Miss√µes Conclu√≠das</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-accent" id="profileStreak">0</div>
                                    <div class="text-sm text-gray-600">Dias Consecutivos</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold text-purple-500" id="profileRank">-</div>
                                    <div class="text-sm text-gray-600">Posi√ß√£o</div>
                                </div>
                            </div>
                        </div>

                        <!-- Hist√≥rico de Miss√µes -->
                        <div class="bg-white rounded-lg shadow p-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Hist√≥rico Recente</h3>
                            <div id="missionHistory" class="space-y-3">
                                <!-- Hist√≥rico ser√° carregado aqui -->
                            </div>
                        </div>
                    </div>

                    <!-- Medalhas -->
                    <div>
                        <div class="bg-white rounded-lg shadow p-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Medalhas</h3>
                            <div class="grid grid-cols-2 gap-4" id="badges">
                                <!-- Medalhas ser√£o carregadas aqui -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Aba Recompensas -->
            <div id="rewardsContent" class="tab-content hidden">
                <div class="mb-8">
                    <h2 class="text-2xl font-bold text-gray-900 mb-2">Recompensas</h2>
                    <p class="text-gray-600">Troque seus pontos por pr√™mios incr√≠veis!</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="rewardsList">
                    <!-- Recompensas ser√£o carregadas aqui -->
                </div>
            </div>
        </main>
    </div>

    <!-- Modal de Miss√£o -->
    <div id="missionModal" class="modal">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="p-6">
                <div class="flex justify-between items-start mb-4">
                    <h3 class="text-lg font-semibold text-gray-900" id="modalMissionTitle">T√≠tulo da Miss√£o</h3>
                    <button onclick="closeMissionModal()" class="text-gray-400 hover:text-gray-600">
                        <span class="text-xl">‚úï</span>
                    </button>
                </div>
                
                <div class="mb-4">
                    <p class="text-gray-600" id="modalMissionDescription">Descri√ß√£o da miss√£o</p>
                    <div class="mt-2 flex items-center text-sm text-accent">
                        <span>‚≠ê</span>
                        <span class="ml-1" id="modalMissionPoints">0 pontos</span>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Comprove que completou a miss√£o:
                    </label>
                    <textarea id="missionProof" 
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                              rows="3" 
                              placeholder="Descreva como voc√™ completou a miss√£o..."></textarea>
                </div>

                <div class="flex space-x-3">
                    <button onclick="closeMissionModal()" 
                            class="flex-1 bg-gray-200 text-gray-800 py-2 px-4 rounded-lg hover:bg-gray-300 transition duration-200">
                        Cancelar
                    </button>
                    <button onclick="completeMission()" 
                            class="flex-1 bg-primary text-white py-2 px-4 rounded-lg hover:bg-indigo-700 transition duration-200">
                        Concluir Miss√£o
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Admin Login -->
    <div id="adminModal" class="modal">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="p-6">
                <div class="flex justify-between items-start mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">Acesso Professor/Admin</h3>
                    <button onclick="closeAdminModal()" class="text-gray-400 hover:text-gray-600">
                        <span class="text-xl">‚úï</span>
                    </button>
                </div>
                
                <form onsubmit="adminLogin(event)" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">C√≥digo de Acesso</label>
                        <input type="password" id="adminCode" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
                               placeholder="Digite o c√≥digo de professor">
                    </div>
                    
                    <div class="flex space-x-3">
                        <button type="button" onclick="closeAdminModal()" 
                                class="flex-1 bg-gray-200 text-gray-800 py-2 px-4 rounded-lg hover:bg-gray-300 transition duration-200">
                            Cancelar
                        </button>
                        <button type="submit" 
                                class="flex-1 bg-primary text-white py-2 px-4 rounded-lg hover:bg-indigo-700 transition duration-200">
                            Entrar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Configura√ß√£o do Supabase
        const SUPABASE_URL = 'https://zwjizjdizqhyhojvcokc.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp3aml6amRpenFoeWhvanZjb2tjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgxOTMxMTUsImV4cCI6MjA3Mzc2OTExNX0.P62qnBUyu0UxugJf24v8pJLZAM4I-D615ezBODxDs7Q';
        
        // Inicializar cliente Supabase (substitua pelas suas credenciais)
        let supabaseClient = null;
        
        // Verificar se as credenciais foram configuradas
        if (SUPABASE_URL !== 'SUA_URL_DO_SUPABASE' && SUPABASE_ANON_KEY !== 'SUA_CHAVE_ANONIMA_DO_SUPABASE') {
            const { createClient } = supabase;
            supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        }
        
        // Estado da aplica√ß√£o
        let currentUser = null;
        let currentTab = 'missions';
        let selectedMission = null;
        let appData = {
            users: [],
            missions: [],
            completedMissions: [],
            rewards: []
        };

        // Dados de exemplo (simulando banco de dados)
        const sampleMissions = [
            {
                id: 1,
                title: "Mantenha a sala limpa",
                description: "Certifique-se de que sua sala esteja organizada ao final do dia",
                type: "daily",
                points: 50,
                icon: "üßπ"
            },
            {
                id: 2,
                title: "N√£o rabisque mesas ou paredes",
                description: "Preserve o patrim√¥nio escolar mantendo m√≥veis e paredes limpos",
                type: "daily",
                points: 30,
                icon: "‚úèÔ∏è"
            },
            {
                id: 3,
                title: "Ajude a organizar a biblioteca",
                description: "Colabore com a organiza√ß√£o dos livros na biblioteca",
                type: "weekly",
                points: 100,
                icon: "üìö"
            },
            {
                id: 4,
                title: "Respeite colegas e professores",
                description: "Mantenha um comportamento respeitoso durante as aulas",
                type: "daily",
                points: 40,
                icon: "ü§ù"
            },
            {
                id: 5,
                title: "Economize √°gua nos bebedouros",
                description: "Use a √°gua de forma consciente nos bebedouros da escola",
                type: "daily",
                points: 35,
                icon: "üíß"
            },
            {
                id: 6,
                title: "Participe da limpeza do p√°tio",
                description: "Ajude a manter o p√°tio da escola limpo e organizado",
                type: "weekly",
                points: 80,
                icon: "üè´"
            },
            {
                id: 7,
                title: "Campanha Anti-Bullying",
                description: "Promova um ambiente escolar mais acolhedor e respeitoso",
                type: "special",
                points: 200,
                icon: "‚ù§Ô∏è"
            }
        ];

        const sampleRewards = [
            {
                id: 1,
                title: "Lanche Especial",
                description: "Um lanche especial na cantina",
                cost: 500,
                icon: "üçï"
            },
            {
                id: 2,
                title: "Dispensa de Tarefa",
                description: "Dispensa de uma tarefa de casa",
                cost: 300,
                icon: "üìù"
            },
            {
                id: 3,
                title: "Certificado de M√©rito",
                description: "Certificado de reconhecimento",
                cost: 800,
                icon: "üèÜ"
            },
            {
                id: 4,
                title: "Tempo Extra no Recreio",
                description: "5 minutos extras no recreio",
                cost: 200,
                icon: "‚è∞"
            }
        ];

        const badges = [
            { id: 1, name: "Guardi√£o da Escola", icon: "üõ°Ô∏è", requirement: "Complete 10 miss√µes" },
            { id: 2, name: "Amigo do Patrim√¥nio", icon: "üèõÔ∏è", requirement: "Complete 5 miss√µes de preserva√ß√£o" },
            { id: 3, name: "Eco Warrior", icon: "üå±", requirement: "Complete 3 miss√µes ambientais" },
            { id: 4, name: "L√≠der da Turma", icon: "üëë", requirement: "Fique em 1¬∫ lugar no ranking" },
            { id: 5, name: "Persistente", icon: "üî•", requirement: "Mantenha streak de 7 dias" },
            { id: 6, name: "Colaborador", icon: "ü§ù", requirement: "Complete 5 miss√µes em grupo" }
        ];

        // Fun√ß√µes do Supabase
        async function initializeSupabase() {
            // Se n√£o h√° cliente Supabase configurado, usar dados locais
            if (!supabaseClient) {
                console.log('Supabase n√£o configurado, usando dados locais');
                appData.missions = [...sampleMissions];
                appData.rewards = [...sampleRewards];
                return;
            }
            
            try {
                // Carregar miss√µes do Supabase
                const { data: missions, error: missionsError } = await supabaseClient
                    .from('missions')
                    .select('*');
                
                if (missionsError) {
                    console.log('Usando dados locais para miss√µes:', missionsError);
                    appData.missions = [...sampleMissions];
                } else {
                    appData.missions = missions.length > 0 ? missions : [...sampleMissions];
                }
                
                // Carregar recompensas do Supabase
                const { data: rewards, error: rewardsError } = await supabaseClient
                    .from('rewards')
                    .select('*');
                
                if (rewardsError) {
                    console.log('Usando dados locais para recompensas:', rewardsError);
                    appData.rewards = [...sampleRewards];
                } else {
                    appData.rewards = rewards.length > 0 ? rewards : [...sampleRewards];
                }
                
                // Se n√£o h√° dados no Supabase, inserir dados de exemplo
                if (missions && missions.length === 0) {
                    await insertSampleData();
                }
                
            } catch (error) {
                console.log('Erro ao conectar com Supabase, usando dados locais:', error);
                appData.missions = [...sampleMissions];
                appData.rewards = [...sampleRewards];
            }
        }
        
        async function insertSampleData() {
            try {
                // Inserir miss√µes de exemplo
                const { error: missionsError } = await supabaseClient
                    .from('missions')
                    .insert(sampleMissions);
                
                if (missionsError) console.log('Erro ao inserir miss√µes:', missionsError);
                
                // Inserir recompensas de exemplo
                const { error: rewardsError } = await supabaseClient
                    .from('rewards')
                    .insert(sampleRewards);
                
                if (rewardsError) console.log('Erro ao inserir recompensas:', rewardsError);
                
            } catch (error) {
                console.log('Erro ao inserir dados de exemplo:', error);
            }
        }
        
        async function saveUserToSupabase(user) {
            if (!supabaseClient) {
                console.log('Supabase n√£o configurado, salvando apenas localmente');
                return false;
            }
            
            try {
                const { data, error } = await supabaseClient
                    .from('users')
                    .upsert({
                        id: user.id,
                        name: user.name,
                        class: user.class,
                        points: user.points,
                        streak: user.streak,
                        last_login: user.lastLogin,
                        completed_missions: user.completedMissions,
                        badges: user.badges
                    });
                
                if (error) {
                    console.log('Erro ao salvar usu√°rio:', error);
                    return false;
                }
                return true;
            } catch (error) {
                console.log('Erro ao conectar com Supabase:', error);
                return false;
            }
        }
        
        async function loadUserFromSupabase(name, studentClass) {
            if (!supabaseClient) {
                return null;
            }
            
            try {
                const { data, error } = await supabaseClient
                    .from('users')
                    .select('*')
                    .eq('name', name)
                    .eq('class', studentClass)
                    .single();
                
                if (error && error.code !== 'PGRST116') {
                    console.log('Erro ao carregar usu√°rio:', error);
                    return null;
                }
                
                if (data) {
                    return {
                        id: data.id,
                        name: data.name,
                        class: data.class,
                        points: data.points,
                        streak: data.streak,
                        lastLogin: data.last_login,
                        completedMissions: data.completed_missions || [],
                        badges: data.badges || []
                    };
                }
                
                return null;
            } catch (error) {
                console.log('Erro ao conectar com Supabase:', error);
                return null;
            }
        }
        
        async function loadAllUsersFromSupabase() {
            if (!supabaseClient) {
                return [];
            }
            
            try {
                const { data, error } = await supabaseClient
                    .from('users')
                    .select('*')
                    .order('points', { ascending: false });
                
                if (error) {
                    console.log('Erro ao carregar usu√°rios:', error);
                    return [];
                }
                
                return data.map(user => ({
                    id: user.id,
                    name: user.name,
                    class: user.class,
                    points: user.points,
                    streak: user.streak,
                    lastLogin: user.last_login,
                    completedMissions: user.completed_missions || [],
                    badges: user.badges || []
                }));
            } catch (error) {
                console.log('Erro ao conectar com Supabase:', error);
                return [];
            }
        }

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        async function initializeApp() {
            // Mostrar loading
            showLoading();
            
            // Inicializar Supabase
            await initializeSupabase();
            
            // Carregar dados do localStorage como fallback
            loadAppData();
            
            // Verificar se h√° usu√°rio logado
            const savedUser = localStorage.getItem('ecoEscolaUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                // Tentar atualizar dados do usu√°rio do Supabase
                const updatedUser = await loadUserFromSupabase(currentUser.name, currentUser.class);
                if (updatedUser) {
                    currentUser = updatedUser;
                    localStorage.setItem('ecoEscolaUser', JSON.stringify(currentUser));
                }
                showStudentApp();
            }
            
            hideLoading();
        }
        
        function showLoading() {
            // Adicionar indicador de loading se necess√°rio
            console.log('Carregando dados...');
        }
        
        function hideLoading() {
            console.log('Dados carregados!');
        }

        function loadAppData() {
            const saved = localStorage.getItem('ecoEscolaData');
            if (saved) {
                appData = JSON.parse(saved);
            }
        }

        function saveAppData() {
            localStorage.setItem('ecoEscolaData', JSON.stringify(appData));
        }

        async function login(event) {
            event.preventDefault();
            
            const name = document.getElementById('studentName').value;
            const studentClass = document.getElementById('studentClass').value;
            
            showLoading();
            
            // Tentar carregar usu√°rio do Supabase
            let user = await loadUserFromSupabase(name, studentClass);
            
            if (!user) {
                // Criar novo usu√°rio
                user = {
                    id: Date.now(),
                    name: name,
                    class: studentClass,
                    points: 0,
                    streak: 0,
                    lastLogin: new Date().toDateString(),
                    completedMissions: [],
                    badges: []
                };
                
                // Salvar no Supabase
                await saveUserToSupabase(user);
                
                // Adicionar aos dados locais como fallback
                appData.users.push(user);
            } else {
                // Atualizar streak
                const today = new Date().toDateString();
                const yesterday = new Date(Date.now() - 86400000).toDateString();
                
                if (user.lastLogin === yesterday) {
                    user.streak += 1;
                } else if (user.lastLogin !== today) {
                    user.streak = 1;
                }
                user.lastLogin = today;
                
                // Salvar altera√ß√µes no Supabase
                await saveUserToSupabase(user);
                
                // Atualizar dados locais
                const userIndex = appData.users.findIndex(u => u.id === user.id);
                if (userIndex !== -1) {
                    appData.users[userIndex] = user;
                } else {
                    appData.users.push(user);
                }
            }
            
            currentUser = user;
            localStorage.setItem('ecoEscolaUser', JSON.stringify(user));
            saveAppData();
            
            hideLoading();
            showStudentApp();
        }

        function logout() {
            currentUser = null;
            localStorage.removeItem('ecoEscolaUser');
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('studentApp').classList.add('hidden');
            
            // Limpar formul√°rio
            document.getElementById('studentName').value = '';
            document.getElementById('studentClass').value = '';
        }

        function showStudentApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('studentApp').classList.remove('hidden');
            
            updateUserInfo();
            loadMissions();
            showTab('missions');
        }

        function updateUserInfo() {
            document.getElementById('userPoints').textContent = currentUser.points;
            document.getElementById('userStreak').textContent = currentUser.streak;
        }

        function showTab(tabName) {
            // Esconder todas as abas
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Remover classe ativa de todos os bot√µes
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('border-primary', 'text-primary');
                btn.classList.add('border-transparent', 'text-gray-500');
            });
            
            // Mostrar aba selecionada
            document.getElementById(tabName + 'Content').classList.remove('hidden');
            
            // Ativar bot√£o da aba
            const activeBtn = document.getElementById(tabName + 'Tab');
            activeBtn.classList.add('border-primary', 'text-primary');
            activeBtn.classList.remove('border-transparent', 'text-gray-500');
            
            currentTab = tabName;
            
            // Carregar conte√∫do espec√≠fico da aba
            switch(tabName) {
                case 'missions':
                    loadMissions();
                    break;
                case 'ranking':
                    loadRanking();
                    break;
                case 'profile':
                    loadProfile();
                    break;
                case 'rewards':
                    loadRewards();
                    break;
            }
        }

        function loadMissions() {
            const dailyContainer = document.getElementById('dailyMissions');
            const weeklyContainer = document.getElementById('weeklyMissions');
            const specialContainer = document.getElementById('specialMissions');
            
            dailyContainer.innerHTML = '';
            weeklyContainer.innerHTML = '';
            specialContainer.innerHTML = '';
            
            appData.missions.forEach(mission => {
                const isCompleted = currentUser.completedMissions.some(cm => 
                    cm.missionId === mission.id && 
                    cm.date === new Date().toDateString()
                );
                
                const missionCard = createMissionCard(mission, isCompleted);
                
                switch(mission.type) {
                    case 'daily':
                        dailyContainer.appendChild(missionCard);
                        break;
                    case 'weekly':
                        weeklyContainer.appendChild(missionCard);
                        break;
                    case 'special':
                        specialContainer.appendChild(missionCard);
                        break;
                }
            });
        }

        function createMissionCard(mission, isCompleted) {
            const card = document.createElement('div');
            card.className = `card-hover rounded-lg p-6 text-white cursor-pointer ${isCompleted ? 'completed-mission' : 'mission-card'}`;
            
            if (!isCompleted) {
                card.onclick = () => openMissionModal(mission);
            }
            
            card.innerHTML = `
                <div class="flex items-start justify-between mb-4">
                    <div class="text-3xl">${mission.icon}</div>
                    <div class="flex items-center text-sm">
                        <span>‚≠ê</span>
                        <span class="ml-1">${mission.points}</span>
                    </div>
                </div>
                <h3 class="font-semibold text-lg mb-2">${mission.title}</h3>
                <p class="text-sm opacity-90 mb-4">${mission.description}</p>
                <div class="flex justify-between items-center">
                    <span class="text-xs opacity-75 capitalize">${mission.type}</span>
                    ${isCompleted ? 
                        '<span class="bg-white bg-opacity-20 px-2 py-1 rounded text-xs">‚úì Conclu√≠da</span>' : 
                        '<span class="bg-white bg-opacity-20 px-2 py-1 rounded text-xs">Clique para completar</span>'
                    }
                </div>
            `;
            
            return card;
        }

        function openMissionModal(mission) {
            selectedMission = mission;
            document.getElementById('modalMissionTitle').textContent = mission.title;
            document.getElementById('modalMissionDescription').textContent = mission.description;
            document.getElementById('modalMissionPoints').textContent = mission.points + ' pontos';
            document.getElementById('missionProof').value = '';
            document.getElementById('missionModal').classList.add('show');
        }

        function closeMissionModal() {
            document.getElementById('missionModal').classList.remove('show');
            selectedMission = null;
        }

        async function completeMission() {
            if (!selectedMission) return;
            
            const proof = document.getElementById('missionProof').value.trim();
            if (!proof) {
                alert('Por favor, descreva como voc√™ completou a miss√£o.');
                return;
            }
            
            showLoading();
            
            // Adicionar miss√£o completada
            const completedMission = {
                missionId: selectedMission.id,
                date: new Date().toDateString(),
                proof: proof,
                points: selectedMission.points
            };
            
            currentUser.completedMissions.push(completedMission);
            currentUser.points += selectedMission.points;
            
            // Verificar badges
            checkBadges();
            
            // Salvar no Supabase
            await saveUserToSupabase(currentUser);
            
            // Atualizar dados locais
            const userIndex = appData.users.findIndex(u => u.id === currentUser.id);
            if (userIndex !== -1) {
                appData.users[userIndex] = currentUser;
            }
            
            localStorage.setItem('ecoEscolaUser', JSON.stringify(currentUser));
            saveAppData();
            
            hideLoading();
            
            // Mostrar notifica√ß√£o
            showNotification(`Miss√£o conclu√≠da! +${selectedMission.points} pontos`);
            
            // Atualizar interface
            updateUserInfo();
            loadMissions();
            closeMissionModal();
        }

        function checkBadges() {
            const completedCount = currentUser.completedMissions.length;
            
            // Guardi√£o da Escola - 10 miss√µes
            if (completedCount >= 10 && !currentUser.badges.includes(1)) {
                currentUser.badges.push(1);
                showNotification('Nova medalha: Guardi√£o da Escola! üõ°Ô∏è');
            }
            
            // Amigo do Patrim√¥nio - 5 miss√µes de preserva√ß√£o
            const preservationMissions = currentUser.completedMissions.filter(cm => {
                const mission = appData.missions.find(m => m.id === cm.missionId);
                return mission && (mission.title.includes('limpa') || mission.title.includes('rabisque') || mission.title.includes('patrim√¥nio'));
            });
            
            if (preservationMissions.length >= 5 && !currentUser.badges.includes(2)) {
                currentUser.badges.push(2);
                showNotification('Nova medalha: Amigo do Patrim√¥nio! üèõÔ∏è');
            }
            
            // Persistente - streak de 7 dias
            if (currentUser.streak >= 7 && !currentUser.badges.includes(5)) {
                currentUser.badges.push(5);
                showNotification('Nova medalha: Persistente! üî•');
            }
        }

        function loadRanking() {
            showRanking('individual');
        }

        function showRanking(type) {
            // Atualizar bot√µes
            document.querySelectorAll('.ranking-filter-btn').forEach(btn => {
                btn.classList.remove('bg-primary', 'text-white');
                btn.classList.add('bg-gray-200', 'text-gray-700');
            });
            
            const activeBtn = type === 'individual' ? 'individualRankingBtn' : 'classRankingBtn';
            const btn = document.getElementById(activeBtn);
            btn.classList.add('bg-primary', 'text-white');
            btn.classList.remove('bg-gray-200', 'text-gray-700');
            
            if (type === 'individual') {
                loadIndividualRanking();
            } else {
                loadClassRanking();
            }
        }

        async function loadIndividualRanking() {
            // Carregar usu√°rios do Supabase
            const supabaseUsers = await loadAllUsersFromSupabase();
            if (supabaseUsers.length > 0) {
                appData.users = supabaseUsers;
            }
            
            const sortedUsers = [...appData.users].sort((a, b) => b.points - a.points);
            
            // P√≥dio
            const podium = document.getElementById('podium');
            podium.innerHTML = '';
            
            if (sortedUsers.length >= 2) {
                // 2¬∫ lugar
                const second = createPodiumCard(sortedUsers[1], 2, 'ranking-silver');
                podium.appendChild(second);
            }
            
            if (sortedUsers.length >= 1) {
                // 1¬∫ lugar
                const first = createPodiumCard(sortedUsers[0], 1, 'ranking-gold');
                podium.appendChild(first);
            }
            
            if (sortedUsers.length >= 3) {
                // 3¬∫ lugar
                const third = createPodiumCard(sortedUsers[2], 3, 'ranking-bronze');
                podium.appendChild(third);
            }
            
            // Lista completa
            const rankingList = document.getElementById('rankingList');
            rankingList.innerHTML = '';
            
            sortedUsers.forEach((user, index) => {
                const isCurrentUser = user.id === currentUser.id;
                const item = document.createElement('div');
                item.className = `flex items-center justify-between p-4 border-b ${isCurrentUser ? 'bg-blue-50 border-blue-200' : 'border-gray-200'}`;
                
                item.innerHTML = `
                    <div class="flex items-center">
                        <div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center mr-3 font-semibold text-sm">
                            ${index + 1}
                        </div>
                        <div>
                            <div class="font-medium ${isCurrentUser ? 'text-blue-600' : 'text-gray-900'}">${user.name}</div>
                            <div class="text-sm text-gray-500">${user.class}</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="font-semibold text-accent">${user.points} pts</div>
                        <div class="text-sm text-gray-500">${user.completedMissions.length} miss√µes</div>
                    </div>
                `;
                
                rankingList.appendChild(item);
            });
        }

        async function loadClassRanking() {
            // Carregar usu√°rios do Supabase
            const supabaseUsers = await loadAllUsersFromSupabase();
            if (supabaseUsers.length > 0) {
                appData.users = supabaseUsers;
            }
            
            // Agrupar por turma
            const classTotals = {};
            appData.users.forEach(user => {
                if (!classTotals[user.class]) {
                    classTotals[user.class] = {
                        class: user.class,
                        totalPoints: 0,
                        studentCount: 0,
                        avgPoints: 0
                    };
                }
                classTotals[user.class].totalPoints += user.points;
                classTotals[user.class].studentCount += 1;
            });
            
            // Calcular m√©dia e ordenar
            const sortedClasses = Object.values(classTotals)
                .map(c => ({
                    ...c,
                    avgPoints: Math.round(c.totalPoints / c.studentCount) || 0
                }))
                .sort((a, b) => b.totalPoints - a.totalPoints);
            
            // P√≥dio
            const podium = document.getElementById('podium');
            podium.innerHTML = '';
            
            if (sortedClasses.length >= 2) {
                const second = createClassPodiumCard(sortedClasses[1], 2, 'ranking-silver');
                podium.appendChild(second);
            }
            
            if (sortedClasses.length >= 1) {
                const first = createClassPodiumCard(sortedClasses[0], 1, 'ranking-gold');
                podium.appendChild(first);
            }
            
            if (sortedClasses.length >= 3) {
                const third = createClassPodiumCard(sortedClasses[2], 3, 'ranking-bronze');
                podium.appendChild(third);
            }
            
            // Lista completa
            const rankingList = document.getElementById('rankingList');
            rankingList.innerHTML = '';
            
            sortedClasses.forEach((classData, index) => {
                const isCurrentUserClass = classData.class === currentUser.class;
                const item = document.createElement('div');
                item.className = `flex items-center justify-between p-4 border-b ${isCurrentUserClass ? 'bg-blue-50 border-blue-200' : 'border-gray-200'}`;
                
                item.innerHTML = `
                    <div class="flex items-center">
                        <div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center mr-3 font-semibold text-sm">
                            ${index + 1}
                        </div>
                        <div>
                            <div class="font-medium ${isCurrentUserClass ? 'text-blue-600' : 'text-gray-900'}">${classData.class}</div>
                            <div class="text-sm text-gray-500">${classData.studentCount} alunos</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="font-semibold text-accent">${classData.totalPoints} pts</div>
                        <div class="text-sm text-gray-500">M√©dia: ${classData.avgPoints} pts</div>
                    </div>
                `;
                
                rankingList.appendChild(item);
            });
        }

        function createPodiumCard(user, position, bgClass) {
            const card = document.createElement('div');
            const height = position === 1 ? 'h-32' : position === 2 ? 'h-24' : 'h-20';
            
            card.className = `${bgClass} ${height} w-24 rounded-lg flex flex-col items-center justify-center text-white text-center p-2`;
            card.innerHTML = `
                <div class="text-2xl mb-1">${position === 1 ? 'ü•á' : position === 2 ? 'ü•à' : 'ü•â'}</div>
                <div class="font-semibold text-xs">${user.name.split(' ')[0]}</div>
                <div class="text-xs opacity-90">${user.points} pts</div>
            `;
            
            return card;
        }

        function createClassPodiumCard(classData, position, bgClass) {
            const card = document.createElement('div');
            const height = position === 1 ? 'h-32' : position === 2 ? 'h-24' : 'h-20';
            
            card.className = `${bgClass} ${height} w-24 rounded-lg flex flex-col items-center justify-center text-white text-center p-2`;
            card.innerHTML = `
                <div class="text-2xl mb-1">${position === 1 ? 'ü•á' : position === 2 ? 'ü•à' : 'ü•â'}</div>
                <div class="font-semibold text-xs">${classData.class}</div>
                <div class="text-xs opacity-90">${classData.totalPoints} pts</div>
            `;
            
            return card;
        }

        function loadProfile() {
            // Atualizar estat√≠sticas
            document.getElementById('profilePoints').textContent = currentUser.points;
            document.getElementById('profileMissions').textContent = currentUser.completedMissions.length;
            document.getElementById('profileStreak').textContent = currentUser.streak;
            
            // Calcular posi√ß√£o no ranking
            const sortedUsers = [...appData.users].sort((a, b) => b.points - a.points);
            const userRank = sortedUsers.findIndex(u => u.id === currentUser.id) + 1;
            document.getElementById('profileRank').textContent = userRank + '¬∫';
            
            // Carregar hist√≥rico
            const historyContainer = document.getElementById('missionHistory');
            historyContainer.innerHTML = '';
            
            const recentMissions = currentUser.completedMissions
                .slice(-5)
                .reverse();
            
            recentMissions.forEach(cm => {
                const mission = appData.missions.find(m => m.id === cm.missionId);
                if (mission) {
                    const item = document.createElement('div');
                    item.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg';
                    item.innerHTML = `
                        <div class="flex items-center">
                            <span class="text-2xl mr-3">${mission.icon}</span>
                            <div>
                                <div class="font-medium text-sm">${mission.title}</div>
                                <div class="text-xs text-gray-500">${cm.date}</div>
                            </div>
                        </div>
                        <div class="text-accent font-semibold">+${cm.points}</div>
                    `;
                    historyContainer.appendChild(item);
                }
            });
            
            if (recentMissions.length === 0) {
                historyContainer.innerHTML = '<p class="text-gray-500 text-center py-4">Nenhuma miss√£o conclu√≠da ainda</p>';
            }
            
            // Carregar medalhas
            const badgesContainer = document.getElementById('badges');
            badgesContainer.innerHTML = '';
            
            badges.forEach(badge => {
                const earned = currentUser.badges.includes(badge.id);
                const badgeElement = document.createElement('div');
                badgeElement.className = `text-center p-3 rounded-lg ${earned ? 'bg-yellow-100 border-2 border-yellow-300' : 'bg-gray-100 border-2 border-gray-200'}`;
                badgeElement.innerHTML = `
                    <div class="text-2xl mb-1 ${earned ? '' : 'grayscale opacity-50'}">${badge.icon}</div>
                    <div class="text-xs font-medium ${earned ? 'text-yellow-800' : 'text-gray-500'}">${badge.name}</div>
                    <div class="text-xs ${earned ? 'text-yellow-600' : 'text-gray-400'} mt-1">${badge.requirement}</div>
                `;
                badgesContainer.appendChild(badgeElement);
            });
        }

        function loadRewards() {
            const container = document.getElementById('rewardsList');
            container.innerHTML = '';
            
            appData.rewards.forEach(reward => {
                const canAfford = currentUser.points >= reward.cost;
                const card = document.createElement('div');
                card.className = `bg-white rounded-lg shadow p-6 ${canAfford ? 'card-hover cursor-pointer' : 'opacity-50'}`;
                
                if (canAfford) {
                    card.onclick = () => redeemReward(reward);
                }
                
                card.innerHTML = `
                    <div class="text-center">
                        <div class="text-4xl mb-4">${reward.icon}</div>
                        <h3 class="font-semibold text-lg mb-2">${reward.title}</h3>
                        <p class="text-gray-600 text-sm mb-4">${reward.description}</p>
                        <div class="flex items-center justify-center text-accent font-semibold">
                            <span>‚≠ê</span>
                            <span class="ml-1">${reward.cost} pontos</span>
                        </div>
                        ${canAfford ? 
                            '<button class="mt-4 w-full bg-primary text-white py-2 rounded-lg hover:bg-indigo-700 transition duration-200">Resgatar</button>' :
                            '<div class="mt-4 text-sm text-gray-500">Pontos insuficientes</div>'
                        }
                    </div>
                `;
                
                container.appendChild(card);
            });
        }

        async function redeemReward(reward) {
            if (currentUser.points < reward.cost) {
                alert('Pontos insuficientes!');
                return;
            }
            
            if (confirm(`Deseja resgatar "${reward.title}" por ${reward.cost} pontos?`)) {
                showLoading();
                
                currentUser.points -= reward.cost;
                
                // Salvar no Supabase
                await saveUserToSupabase(currentUser);
                
                // Atualizar dados locais
                const userIndex = appData.users.findIndex(u => u.id === currentUser.id);
                if (userIndex !== -1) {
                    appData.users[userIndex] = currentUser;
                }
                
                localStorage.setItem('ecoEscolaUser', JSON.stringify(currentUser));
                saveAppData();
                
                hideLoading();
                
                showNotification(`Recompensa resgatada: ${reward.title}! üéâ`);
                updateUserInfo();
                loadRewards();
            }
        }

        function showNotification(message) {
            const notification = document.getElementById('notification');
            document.getElementById('notificationText').textContent = message;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function hideNotification() {
            document.getElementById('notification').classList.remove('show');
        }

        function showAdminLogin() {
            document.getElementById('adminModal').classList.add('show');
        }

        function closeAdminModal() {
            document.getElementById('adminModal').classList.remove('show');
            document.getElementById('adminCode').value = '';
        }

        function adminLogin(event) {
            event.preventDefault();
            const code = document.getElementById('adminCode').value;
            
            // C√≥digo simples para demo (em produ√ß√£o seria mais seguro)
            if (code === 'admin123') {
                alert('Funcionalidade de admin ser√° implementada em breve!');
                closeAdminModal();
            } else {
                alert('C√≥digo incorreto!');
            }
        }

        // Fechar modais ao clicar fora
        window.onclick = function(event) {
            const missionModal = document.getElementById('missionModal');
            const adminModal = document.getElementById('adminModal');
            
            if (event.target === missionModal) {
                closeMissionModal();
            }
            if (event.target === adminModal) {
                closeAdminModal();
            }
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9814594780ddf623',t:'MTc1ODIzNTI2NS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
